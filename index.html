<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PhysioNote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --border:#d1d5db;
      --border-strong:#9ca3af;
      --accent:#06b6d4;
      --accent-soft:rgba(6,182,212,.10);
      --accent-dark:#0f172a;
      --text:#111827;
      --muted:#6b7280;
      --danger:#b91c1c;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(15,23,42,.06);
      --shadow2: 0 22px 70px rgba(15,23,42,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell{
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px 16px 44px;
    }

    .card{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 18px 20px;
    }
    .card + .card { margin-top: 16px; }

    /* Header */
    .hero{
      position: relative;
      overflow: hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-45%;
      background:
        radial-gradient(circle at top, rgba(15,118,190,0.14), transparent 55%),
        radial-gradient(circle at 20% 30%, rgba(6,182,212,0.16), transparent 50%);
      pointer-events:none;
    }
    .hero-inner{
      position: relative;
      z-index: 1;
      display:flex;
      justify-content:space-between;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .brand{
      min-width: 260px;
      flex: 1;
    }
    .title{
      margin:0;
      font-weight: 900;
      letter-spacing: -0.04em;
      color: var(--accent-dark);
      font-size: 30px;
      line-height: 1.05;
    }
    .title span{
      background: linear-gradient(to right, #0f172a, #0284c7);
      -webkit-background-clip:text; background-clip:text;
      color: transparent;
    }
    .sub{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 720px;
    }

    /* Voice HUD */
    .hud{
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      min-width: 280px;
    }
    .mic{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.78);
      box-shadow: 0 10px 24px rgba(15,23,42,0.06);
      user-select:none;
      white-space: nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(107,114,128,.35);
    }
    .mic.active{ border-color: rgba(34,197,94,.35); }
    .mic.active .dot{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.12); }
    .mic.error{ border-color: rgba(239,68,68,.35); }
    .mic.error .dot{ background: var(--danger); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }

    .hudline{
      font-size: 11px;
      color: var(--muted);
      padding: 7px 10px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.70);
      border-radius: 999px;
      max-width: 360px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .hud{ align-items:flex-start; min-width: auto; }
      .hero-inner{ align-items: flex-start; }
    }

    /* Form */
    .section-title{
      margin:0 0 10px;
      font-size: 14px;
      font-weight: 900;
      color: var(--accent-dark);
    }
    label{
      display:block;
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    input[type="text"], textarea, select{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text);
      font-size: 13px;
      padding: 10px 12px;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    input:focus, textarea:focus, select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6,182,212,.20);
      background: #ffffff;
    }
    textarea{
      resize: vertical;
      line-height: 1.45;
      min-height: 120px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .row-left{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .stack{ display:flex; flex-direction:column; gap: 10px; }

    /* Buttons */
    .button{
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      transition: all .15s ease-out;
      user-select:none;
      white-space: nowrap;
    }
    .button-primary{
      background: var(--accent);
      color: #ecfeff;
      box-shadow: 0 10px 26px rgba(6,182,212,.30);
    }
    .button-primary:hover{ filter:brightness(1.03); transform: translateY(-1px); }
    .button-ghost{
      background: #f9fafb;
      color: var(--accent-dark);
      border:1px solid var(--border);
    }
    .button-ghost:hover{ background:#fff; }
    .button-danger{
      background:#fee2e2;
      color: var(--danger);
      border:1px solid #fecaca;
    }
    .button-small{ padding: 7px 12px; font-size: 12px; }

    /* Focus ring */
    .focus-ring{
      outline: 2px solid rgba(6,182,212,.95) !important;
      box-shadow: 0 0 0 4px rgba(6,182,212,.14) !important;
      background: #fff !important;
    }

    /* Console */
    .console{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,0.10);
      background: linear-gradient(180deg, #fbfdff, #f9fafb);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.04);
    }
    .console h4{
      margin:0 0 8px;
      font-size: 12px;
      color: var(--accent-dark);
      letter-spacing: .02em;
    }
    .kv{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .k{ color:#334155; font-weight: 800; }
    .v{ color:#475569; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .line{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      padding: 9px 10px;
      border: 1px dashed rgba(15,23,42,0.14);
      border-radius: 12px;
      background: rgba(255,255,255,0.70);
      line-height: 1.35;
      word-break: break-word;
    }

    /* Tabs */
    .tab-buttons{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .tab-label{
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--muted);
      user-select: none;
      font-weight: 900;
    }
    .tab-label.active{
      background: var(--accent);
      color: #ecfeff;
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(6,182,212,.30);
    }
    .tab-panels{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 12px 14px;
    }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    /* Small helpers */
    .meta{
      font-size: 12px;
      color: var(--muted);
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 5px 10px; border-radius:999px;
      font-size: 11px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.70);
      color: #475569;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <!-- Header -->
    <div class="card hero">
      <div class="hero-inner">
        <div class="brand">
          <h1 class="title"><span>PhysioNote</span></h1>
          <p class="sub">
            Sprachgesteuerte Physiotherapie-Dokumentation: Felder, Tabs und Aktionen ‚Äì vollst√§ndig per Stimme bedienbar.
          </p>
          <div class="meta" style="margin-top:10px;">
            <span class="badge"><span class="mono">Start Listening</span> / <span class="mono">Stop Listening</span></span>
            <span class="badge"><span class="mono">√ñffne Anamnese</span> (startet Aufnahme)</span>
            <span class="badge"><span class="mono">Schlie√üen</span> (stoppt Aufnahme)</span>
          </div>
        </div>

        <div class="hud">
          <div id="micBox" class="mic">
            <span class="dot" id="micDot"></span>
            <span id="micText">Mikrofon bereit</span>
          </div>
          <div class="hudline" id="hudHeard">Geh√∂rt: ‚Äì</div>
          <div class="hudline" id="hudAction">Aktion: ‚Äì</div>
        </div>
      </div>
    </div>

    <!-- Patient -->
    <div class="card">
      <div class="row" style="margin-bottom: 10px;">
        <div>
          <h3 class="section-title">Patient</h3>
          <div class="meta">Voice-Beispiele: <span class="mono">‚ÄûName Max Mustermann‚Äú</span> ¬∑ <span class="mono">‚ÄûGeburtsdatum 20.12.1996‚Äú</span> ¬∑ <span class="mono">‚ÄûTelefon +41 79 ‚Ä¶‚Äú</span></div>
        </div>

        <div class="row-left">
          <button id="btnStart" class="button button-primary" type="button">üéôÔ∏è Start Listening</button>
          <button id="btnStop" class="button button-ghost" type="button">Stop</button>
          <button id="btnReset" class="button button-danger" type="button">Reset</button>
        </div>
      </div>

      <div class="grid">
        <div class="stack">
          <div>
            <label for="patient-name">Name *</label>
            <input id="patient-name" type="text" placeholder="Max Mustermann" autocomplete="off" />
          </div>

          <div class="row" style="gap:10px;">
            <div style="flex: 1;">
              <label for="patient-birthdate">Geburtsdatum</label>
              <input id="patient-birthdate" type="text" placeholder="20.12.1996" autocomplete="off" />
            </div>
            <div style="flex: 1;">
              <label for="patient-id">Patienten-ID (optional)</label>
              <input id="patient-id" type="text" placeholder="z. B. EXT-12345" autocomplete="off" />
            </div>
          </div>

          <div class="row" style="gap:10px;">
            <div style="flex: 1;">
              <label for="patient-phone">Telefon (optional)</label>
              <input id="patient-phone" type="text" placeholder="+41 79 123 45 67" autocomplete="off" />
            </div>
            <div style="flex: 1;">
              <label for="patient-email">E-Mail (optional)</label>
              <input id="patient-email" type="text" placeholder="max@example.com" autocomplete="off" />
            </div>
          </div>

          <div class="row" style="margin-top: 4px;">
            <div class="meta" id="activeFieldLabel">Aktives Feld: ‚Äì</div>
            <div class="row-left">
              <button id="btnCreate" class="button button-primary" type="button">+ Patient anlegen</button>
              <button id="btnClearField" class="button button-ghost" type="button">üßπ Feld l√∂schen</button>
            </div>
          </div>
        </div>

        <div class="console">
          <h4>Live</h4>
          <div class="kv">
            <div class="k">Listening</div><div class="v" id="kvMode">AUS</div>
            <div class="k">Aufnahme</div><div class="v" id="kvRec">AUS</div>
            <div class="k">Tab</div><div class="v" id="kvTab">Anamnese</div>
            <div class="k">Fokus</div><div class="v" id="kvFocus">‚Äì</div>
            <div class="k">Letzter Text</div><div class="v mono" id="kvRaw">‚Äì</div>
            <div class="k">Interpretation</div><div class="v mono" id="kvInterp">‚Äì</div>
          </div>
          <div class="line" id="consoleStatus">Status: bereit.</div>
          <div class="meta" style="margin-top:10px;">
            Kommandos: <span class="mono">√ñffne ‚Ä¶</span> ¬∑ <span class="mono">Schlie√üen</span> ¬∑ <span class="mono">Speichern</span> ¬∑ <span class="mono">Kopieren</span> ¬∑ <span class="mono">Reset</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Sitzung -->
    <div class="card">
      <div class="row" style="margin-bottom: 10px;">
        <div>
          <h3 class="section-title">Sitzung</h3>
          <div class="meta">Workflow: <span class="mono">‚Äû√ñffne Anamnese‚Äú</span> ‚Üí sprechen ‚Üí <span class="mono">‚ÄûSchlie√üen‚Äú</span> ‚Üí <span class="mono">‚Äû√ñffne Befund‚Äú</span> ‚Ä¶</div>
        </div>

        <div class="row-left">
          <button id="btnSave" class="button button-primary" type="button">üíæ Speichern</button>
          <button id="btnCopy" class="button button-ghost" type="button">üìã Kopieren</button>
        </div>
      </div>

      <div class="tab-buttons" id="tabButtons">
        <button type="button" class="tab-label active" data-tab="anamnese">Anamnese</button>
        <button type="button" class="tab-label" data-tab="befund">Befund</button>
        <button type="button" class="tab-label" data-tab="diagnose">Diagnose</button>
        <button type="button" class="tab-label" data-tab="therapieplan">Therapieplan</button>
        <button type="button" class="tab-label" data-tab="verlauf">Verlauf</button>
        <button type="button" class="tab-label" data-tab="epikrise">Epikrise</button>
      </div>

      <div class="tab-panels" id="tabPanels">
        <div class="tab-panel active" data-panel="anamnese">
          <label for="t-anamnese">Anamnese</label>
          <textarea id="t-anamnese" placeholder="Sprich nach ‚Äû√ñffne Anamnese‚Äú ‚Ä¶"></textarea>
        </div>
        <div class="tab-panel" data-panel="befund">
          <label for="t-befund">Befund</label>
          <textarea id="t-befund" placeholder="Sprich nach ‚Äû√ñffne Befund‚Äú ‚Ä¶"></textarea>
        </div>
        <div class="tab-panel" data-panel="diagnose">
          <label for="t-diagnose">Diagnose</label>
          <textarea id="t-diagnose" placeholder="Sprich nach ‚Äû√ñffne Diagnose‚Äú ‚Ä¶"></textarea>
        </div>
        <div class="tab-panel" data-panel="therapieplan">
          <label for="t-therapieplan">Therapieplan</label>
          <textarea id="t-therapieplan" placeholder="Sprich nach ‚Äû√ñffne Therapieplan‚Äú ‚Ä¶"></textarea>
        </div>
        <div class="tab-panel" data-panel="verlauf">
          <label for="t-verlauf">Verlauf</label>
          <textarea id="t-verlauf" placeholder="Sprich nach ‚Äû√ñffne Verlauf‚Äú ‚Ä¶"></textarea>
        </div>
        <div class="tab-panel" data-panel="epikrise">
          <label for="t-epikrise">Epikrise</label>
          <textarea id="t-epikrise" placeholder="Sprich nach ‚Äû√ñffne Epikrise‚Äú ‚Ä¶"></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   PhysioNote ‚Äì Voice-First UI
   - One mic: "Start Listening" enables recognition
   - "√ñffne <Bereich>" => selects tab AND starts recording into its textarea
   - "Schlie√üen" => stops recording (no more text appended)
   - All actions controllable by voice
   ========================================================= */

(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  // UI elements
  const micBox = document.getElementById("micBox");
  const micText = document.getElementById("micText");
  const hudHeard = document.getElementById("hudHeard");
  const hudAction = document.getElementById("hudAction");

  const kvMode = document.getElementById("kvMode");
  const kvRec = document.getElementById("kvRec");
  const kvTab = document.getElementById("kvTab");
  const kvFocus = document.getElementById("kvFocus");
  const kvRaw = document.getElementById("kvRaw");
  const kvInterp = document.getElementById("kvInterp");
  const consoleStatus = document.getElementById("consoleStatus");
  const activeFieldLabel = document.getElementById("activeFieldLabel");

  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnReset = document.getElementById("btnReset");
  const btnCreate = document.getElementById("btnCreate");
  const btnClearField = document.getElementById("btnClearField");
  const btnSave = document.getElementById("btnSave");
  const btnCopy = document.getElementById("btnCopy");

  // Inputs
  const patient = {
    name: document.getElementById("patient-name"),
    birthdate: document.getElementById("patient-birthdate"),
    id: document.getElementById("patient-id"),
    phone: document.getElementById("patient-phone"),
    email: document.getElementById("patient-email"),
  };

  // Tabs
  const TAB_KEYS = ["anamnese","befund","diagnose","therapieplan","verlauf","epikrise"];
  const tabButtons = [...document.querySelectorAll(".tab-label")];
  const tabPanels  = [...document.querySelectorAll(".tab-panel")];

  const textareas = {
    anamnese: document.getElementById("t-anamnese"),
    befund: document.getElementById("t-befund"),
    diagnose: document.getElementById("t-diagnose"),
    therapieplan: document.getElementById("t-therapieplan"),
    verlauf: document.getElementById("t-verlauf"),
    epikrise: document.getElementById("t-epikrise"),
  };

  // State
  let recognition = null;
  let listening = false;
  let recording = false;           // when true, append speech to active textarea
  let activeTab = "anamnese";      // default
  let focusEl = null;
  let focusLabel = "";
  let lastRaw = "";
  let lastInterp = "";

  // Helpers
  function setHUD(heard, action){
    hudHeard.textContent = "Geh√∂rt: " + (heard || "‚Äì");
    hudAction.textContent = "Aktion: " + (action || "‚Äì");
  }
  function setConsole(text){
    consoleStatus.textContent = "Status: " + text;
  }
  function normalize(s){
    return (s||"")
      .toLowerCase()
      .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/√ü/g,"ss")
      .replace(/[^\p{L}\p{N}\s:.\-+@/]/gu, " ")
      .replace(/\s+/g," ")
      .trim();
  }
  function stripWake(t){
    // optional wakewords, harmless if absent
    return t.replace(/^kintaro\s+/,"").replace(/^physionote\s+/,"").trim();
  }
  function pad2(n){ return String(n).padStart(2,"0"); }

  const MONTHS = {
    januar:1, jan:1, februar:2, feb:2, maerz:3, m√§rz:3, april:4, apr:4, mai:5,
    juni:6, jun:6, juli:7, jul:7, august:8, aug:8, september:9, sep:9,
    oktober:10, okt:10, november:11, nov:11, dezember:12, dez:12
  };

  function tryNormalizeDate(val){
    const v = (val||"").trim();
    let m = v.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
    if(m){
      let d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
      if(y < 100) y = 1900 + y;
      if(d>=1 && d<=31 && mo>=1 && mo<=12 && y>=1900 && y<=2100) return `${pad2(d)}.${pad2(mo)}.${y}`;
    }
    m = normalize(v).match(/^(\d{1,2})\s*\.?\s*([a-z√§√∂√º]+)\s+(\d{4})$/i);
    if(m){
      const d = parseInt(m[1],10), mon = (m[2]||"").toLowerCase(), y = parseInt(m[3],10);
      const mo = MONTHS[mon];
      if(mo && d>=1 && d<=31 && y>=1900 && y<=2100) return `${pad2(d)}.${pad2(mo)}.${y}`;
    }
    return null;
  }

  function clearFocusRing(){
    document.querySelectorAll(".focus-ring").forEach(el => el.classList.remove("focus-ring"));
  }

  function setFocus(el, label){
    clearFocusRing();
    focusEl = el;
    focusLabel = label || "";
    if(el){
      el.classList.add("focus-ring");
      try{ el.focus({preventScroll:false}); }catch(e){}
    }
    activeFieldLabel.textContent = "Aktives Feld: " + (focusLabel || "‚Äì");
    kvFocus.textContent = focusLabel || "‚Äì";
  }

  function setActiveTab(key){
    activeTab = key;
    // activate UI
    tabButtons.forEach(b => b.classList.remove("active"));
    tabPanels.forEach(p => p.classList.remove("active"));

    const btn = tabButtons.find(b => b.getAttribute("data-tab") === key);
    btn?.classList.add("active");
    document.querySelector(`.tab-panel[data-panel="${key}"]`)?.classList.add("active");

    kvTab.textContent = key.charAt(0).toUpperCase() + key.slice(1);
    setFocus(textareas[key], kvTab.textContent);
  }

  function setMicUI(){
    kvMode.textContent = listening ? "AN" : "AUS";
    kvRec.textContent = recording ? "AN" : "AUS";
    kvRaw.textContent = lastRaw || "‚Äì";
    kvInterp.textContent = lastInterp || "‚Äì";

    micBox.classList.remove("active","error");
    if(listening){
      micBox.classList.add("active");
      micText.textContent = recording ? "Aufnahme l√§uft" : "Listening aktiv";
    } else {
      micText.textContent = "Mikrofon bereit";
    }
  }

  function resetAll(){
    Object.values(patient).forEach(i => i.value = "");
    Object.values(textareas).forEach(t => t.value = "");
    recording = false;
    setActiveTab("anamnese");
    setFocus(null,"");
    setConsole("Zur√ºckgesetzt.");
    setHUD("‚Äì","Reset");
    lastInterp = "reset()";
    lastRaw = "";
    setMicUI();
  }

  // Actions
  function createPatient(){
    const name = (patient.name.value||"").trim();
    if(!name){
      setConsole("Bitte Name setzen.");
      setHUD(lastRaw, "Name fehlt");
      setFocus(patient.name, "Name");
      lastInterp = "create_patient_failed(name_missing)";
      setMicUI();
      return;
    }
    setConsole("Patient angelegt.");
    setHUD(lastRaw, "Patient anlegen");
    lastInterp = "create_patient()";
    setMicUI();
  }

  function clearFocusedField(){
    if(!focusEl){
      setConsole("Kein aktives Feld.");
      setHUD(lastRaw, "Feld l√∂schen (kein Fokus)");
      lastInterp = "clear_field_failed(no_focus)";
      setMicUI();
      return;
    }
    focusEl.value = "";
    focusEl.dispatchEvent(new Event("input"));
    setConsole("Feld gel√∂scht: " + (focusLabel || "‚Äì"));
    setHUD(lastRaw, "Feld gel√∂scht");
    lastInterp = "clear_field()";
    setMicUI();
  }

  function save(){
    setConsole("Gespeichert.");
    setHUD(lastRaw, "Speichern");
    lastInterp = "save()";
    setMicUI();
  }

  async function copyAll(){
    const payload = [
      `Name: ${patient.name.value || "-"}`,
      `Geburtsdatum: ${patient.birthdate.value || "-"}`,
      `Patienten-ID: ${patient.id.value || "-"}`,
      `Telefon: ${patient.phone.value || "-"}`,
      `E-Mail: ${patient.email.value || "-"}`,
      "",
      "ANAMNESE:",
      textareas.anamnese.value || "",
      "",
      "BEFUND:",
      textareas.befund.value || "",
      "",
      "DIAGNOSE:",
      textareas.diagnose.value || "",
      "",
      "THERAPIEPLAN:",
      textareas.therapieplan.value || "",
      "",
      "VERLAUF:",
      textareas.verlauf.value || "",
      "",
      "EPIKRISE:",
      textareas.epikrise.value || ""
    ].join("\n");

    try{
      await navigator.clipboard.writeText(payload);
      setConsole("Kopiert.");
      setHUD(lastRaw, "Kopieren");
      lastInterp = "copy()";
    }catch(e){
      setConsole("Kopieren nicht m√∂glich (Berechtigung).");
      setHUD(lastRaw, "Kopieren fehlgeschlagen");
      lastInterp = "copy_failed()";
    }
    setMicUI();
  }

  // Field mapping
  const FIELD_SYNONYMS = [
    { key:"name", label:"Name", el: patient.name, syn:["name","patient","patientname","patientenname"] },
    { key:"birthdate", label:"Geburtsdatum", el: patient.birthdate, syn:["geburtsdatum","geburtstag","geb datum","geburt"] },
    { key:"id", label:"Patienten-ID", el: patient.id, syn:["id","patient id","patienten id","externe id","interne id","fall id","case id"] },
    { key:"phone", label:"Telefon", el: patient.phone, syn:["telefon","handy","nummer","telefonnummer","tel"] },
    { key:"email", label:"e mail", el: patient.email, syn:["email","e mail","e-mail","mail"] },
  ];

  function keyFromHead(head){
    const h = normalize(head);
    for(const f of FIELD_SYNONYMS){
      for(const s of f.syn){
        if(h === normalize(s)) return f;
      }
    }
    return null;
  }

  function setFieldValue(fieldObj, value){
    if(!fieldObj) return false;
    let v = value;

    if(fieldObj.key === "birthdate"){
      const nd = tryNormalizeDate(value);
      if(nd) v = nd;
    }
    if(fieldObj.key === "email"){
      v = v.replace(/\s+/g,"").trim();
    }
    if(fieldObj.key === "phone"){
      v = v.replace(/[^\d+\s]/g,"").replace(/\s+/g," ").trim();
    }

    setFocus(fieldObj.el, fieldObj.label);
    fieldObj.el.value = v;
    fieldObj.el.dispatchEvent(new Event("input"));
    setConsole(`${fieldObj.label} gesetzt.`);
    setHUD(lastRaw, `Setze ${fieldObj.label}`);
    lastInterp = `set(${fieldObj.key},"${v}")`;
    setMicUI();
    return true;
  }

  // Recording control
  function startRecordingInto(tabKey){
    setActiveTab(tabKey);
    recording = true;
    setConsole(`Aufnahme: ${tabKey}`);
    setHUD(lastRaw, `Aufnahme an ‚Üí ${tabKey}`);
    lastInterp = `record_on(${tabKey})`;
    setMicUI();
  }

  function stopRecording(){
    recording = false;
    setConsole("Aufnahme gestoppt.");
    setHUD(lastRaw, "Aufnahme aus");
    lastInterp = "record_off()";
    setMicUI();
  }

  // Speech engine
  function buildRecognition(){
    if(!SR){
      micBox.classList.add("error");
      micText.textContent = "Speech API fehlt";
      setConsole("Browser unterst√ºtzt SpeechRecognition nicht. Nutze Chrome (Desktop/Android).");
      setHUD("‚Äì","Nicht unterst√ºtzt");
      setMicUI();
      return null;
    }
    const r = new SR();
    r.lang = "de-DE";
    r.continuous = true;
    r.interimResults = false;
    return r;
  }

  function startListening(){
    if(listening) return;
    recognition = buildRecognition();
    if(!recognition) return;

    recognition.onstart = ()=>{
      listening = true;
      setConsole("Listening aktiv.");
      setHUD("‚Äì","Listening an");
      lastInterp = "listening_on()";
      setMicUI();
    };

    recognition.onerror = (e)=>{
      micBox.classList.add("error");
      setConsole(`Mikro Fehler: ${e.error || "unknown"}`);
      setHUD(lastRaw, "Speech error");
      lastInterp = `error(${e.error||"unknown"})`;
      setMicUI();
    };

    recognition.onend = ()=>{
      // Auto-restart while listening
      if(listening){
        try{ recognition.start(); }catch(e){}
      } else {
        setMicUI();
      }
    };

    recognition.onresult = (ev)=>{
      const raw = ev.results[ev.results.length-1][0].transcript || "";
      lastRaw = raw.trim();
      kvRaw.textContent = lastRaw || "‚Äì";
      setHUD(lastRaw, "‚Ä¶");

      const t = stripWake(normalize(raw));

      // --- Global
      if(t === "stop" || t.includes("stop listening") || t.includes("listening stoppen") || t.includes("mikro aus") || t.includes("mikrofon aus")){
        stopListening();
        return;
      }
      if(t === "reset" || t.includes("alles loeschen") || t.includes("alles l√∂schen") || t.includes("reset felder")){
        resetAll();
        return;
      }

      // --- Close / stop recording
      if(t === "schliessen" || t === "schlie√üen" || t.includes("schliessen") || t.includes("schlie√üen") || t.includes("aufnahme stoppen")){
        stopRecording();
        return;
      }

      // --- Actions
      if(t.includes("patient anlegen") || t.includes("patient erstellen") || t === "anlegen"){
        createPatient(); return;
      }
      if(t === "speichern" || t.includes("sitzung speichern")){
        save(); return;
      }
      if(t.includes("kopieren") || t.includes("zwischenablage")){
        copyAll(); return;
      }
      if(t.includes("feld loeschen") || t.includes("feld l√∂schen") || t.includes("loesche feld") || t.includes("l√∂sche feld") || t.includes("loeschen") || t.includes("l√∂schen")){
        clearFocusedField(); return;
      }

      // --- "√ñffne <Tab>" => select + record into it
      // Accept: "√∂ffne anamnese", "anamnese", "√∂ffne anamnesebogen", "anamnese bogen"
      const tabAliases = {
        anamnese: ["anamnese","anamnesebogen","anamnese bogen","anamnese von bogen","anamnese vom bogen","anamnese formular","anamneseblatt"],
        befund: ["befund","status","befundbogen","befund bogen"],
        diagnose: ["diagnose","einschaetzung","einsch√§tzung","diagnosebogen","diagnose bogen"],
        therapieplan: ["therapieplan","therapie plan","plan","therapieplan bogen","therapie bogen"],
        verlauf: ["verlauf","verlauf bogen","verlaufsbogen","verlauf vom bogen"],
        epikrise: ["epikrise","abschluss","abschlussbericht","epikrise bogen"],
      };

      // if phrase contains "√∂ffne"
      if(t.startsWith("oeffne ") || t.startsWith("√∂ffne ")){
        const rest = t.replace(/^oeffne\s+|^√∂ffne\s+/,"").trim();
        for(const key of TAB_KEYS){
          const al = tabAliases[key] || [key];
          if(al.some(a => rest === normalize(a) || rest.includes(normalize(a)))){
            startRecordingInto(key);
            return;
          }
        }
      } else {
        // direct: "anamnese", "befund" etc -> also start recording
        for(const key of TAB_KEYS){
          const al = tabAliases[key] || [key];
          if(al.some(a => t === normalize(a))){
            startRecordingInto(key);
            return;
          }
        }
      }

      // --- Set patient fields: "Name Max", "Name: Max", "Setze Name auf Max"
      let m = t.match(/^(setze|korrigiere)\s+(.+?)\s+(auf|zu)\s+(.+)$/);
      if(m){
        const f = keyFromHead(m[2].trim());
        if(f){ setFieldValue(f, m[4].trim()); return; }
      }
      m = t.match(/^(.+?)\s*:\s*(.+)$/);
      if(m){
        const f = keyFromHead(m[1].trim());
        if(f){ setFieldValue(f, m[2].trim()); return; }
      }

      // "Head Value" - longest synonym match
      const synCandidates = FIELD_SYNONYMS
        .flatMap(f => f.syn.map(s => ({f, syn: normalize(s)})))
        .sort((a,b)=> b.syn.length - a.syn.length);

      for(const c of synCandidates){
        if(t === c.syn){
          setFocus(c.f.el, c.f.label);
          setConsole("Fokus: " + c.f.label);
          setHUD(lastRaw, "Fokus");
          lastInterp = `focus(${c.f.key})`;
          setMicUI();
          return;
        }
        if(t.startsWith(c.syn + " ")){
          const val = t.slice(c.syn.length).trim();
          if(val){
            setFieldValue(c.f, val);
            return;
          }
        }
      }

      // --- If recording: append to active tab textarea
      if(recording && activeTab && textareas[activeTab]){
        const ta = textareas[activeTab];
        ta.value = (ta.value ? ta.value + " " : "") + lastRaw;
        ta.dispatchEvent(new Event("input"));
        setFocus(ta, kvTab.textContent);
        setConsole("Aufnahme l√§uft‚Ä¶");
        setHUD(lastRaw, "Append ‚Üí " + activeTab);
        lastInterp = "append(active_tab)";
        setMicUI();
        return;
      }

      // --- If not recording: if focused input, set it
      if(!recording && focusEl && focusEl.tagName === "INPUT"){
        focusEl.value = lastRaw;
        focusEl.dispatchEvent(new Event("input"));
        setConsole("Wert gesetzt.");
        setHUD(lastRaw, "Set focused input");
        lastInterp = "set_focused_input()";
        setMicUI();
        return;
      }

      setConsole("Nicht erkannt. Nutze z. B. ‚Äû√ñffne Anamnese‚Äú oder ‚ÄûName Max Mustermann‚Äú.");
      setHUD(lastRaw, "Unklar");
      lastInterp = "unhandled()";
      setMicUI();
    };

    try{ recognition.start(); }catch(e){}
  }

  function stopListening(){
    listening = false;
    recording = false;
    try{ recognition && recognition.stop(); }catch(e){}
    setConsole("Listening gestoppt.");
    setHUD(lastRaw, "Listening aus");
    lastInterp = "listening_off()";
    setMicUI();
  }

  // Buttons
  btnStart.addEventListener("click", startListening);
  btnStop.addEventListener("click", stopListening);
  btnReset.addEventListener("click", resetAll);
  btnCreate.addEventListener("click", createPatient);
  btnClearField.addEventListener("click", clearFocusedField);
  btnSave.addEventListener("click", save);
  btnCopy.addEventListener("click", copyAll);

  // Keyboard (optional)
  document.addEventListener("keydown", (e)=>{
    if(e.code === "Space" && !e.repeat){
      e.preventDefault();
      if(!listening) startListening();
      else stopListening();
    }
    if(e.code === "Escape"){
      recording = false;
      clearFocusRing();
      focusEl = null;
      focusLabel = "";
      activeFieldLabel.textContent = "Aktives Feld: ‚Äì";
      kvFocus.textContent = "‚Äì";
      setConsole("Fokus aus. Aufnahme aus.");
      setHUD("‚Äì","Fokus aus");
      lastInterp = "escape()";
      setMicUI();
    }
  });

  // Init
  setActiveTab("anamnese");
  setMicUI();
  setConsole("Bereit.");
})();
</script>

</body>
</html>